#!/usr/bin/perl
use strict;
use warnings;
use File::Path;
use Getopt::Long;

GetOptions( \my %conf, 'debug!', 'verbose!' )
    or die "Usaage: $0 [ --debug ] [ --verbose ]";

# prepare some basic stuff
my $depth = shift || 0;
my $dir = "sierpinski-$depth";
rmtree($dir);    # cleanup
mkpath($dir);
chdir $dir;

# prepare empty tree
`git init ; touch a ; git add a ; git commit -m empty ; git rm a ; git commit -m null`;
my $tree = `git log -1 --pretty=format:%T`;

# create root node
my $count = 0;
chomp( my $root = `echo @{ [ $count++ ] } | git commit-tree $tree` );
`git reset --hard $root`;

# a cache for nodes
my %cache;

sub child {
    my $cmd = qq{echo @{ [ $count++ ] } | git commit-tree $tree -p $_[0]};
    print "$cmd\n" if $conf{debug};
    chomp( my $node = `sleep 1; $cmd` );    # for --date-order
    print "$_[0] -> $node\n" if $conf{verbose};
    return $node;
}

sub merge {
    my @p = grep defined, @_;
    my $id = join ':', sort @p;
    my $cmd
        = qq{echo @{ [ $count++ ] } | git commit-tree $tree @{ [ map {"-p $_"} @p ] }};
    print "$cmd\n" if $conf{debug};
    return $cache{$id} if exists $cache{$id};

    chomp( $cache{$id} = `sleep 1; $cmd` );    # for --date-order
    print "$id -> $cache{$id}\n" if $conf{verbose};
    return $cache{$id};
}

sub triangle {
    my ( $n, $top, @merge ) = @_;
    return $top if !$n;

    my $left = child($top);
    my @left = triangle( $n -1 , $left, @merge );
    my $right = merge( $top, $left );
    `git reset --hard $right`;
    my @right = triangle( $n -1 ,$right, @merge );
    return @right;
}

triangle( $depth, $root );

